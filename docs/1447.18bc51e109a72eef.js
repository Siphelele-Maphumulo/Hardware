"use strict";(self.webpackChunkapp=self.webpackChunkapp||[]).push([[1447],{1447:(Q,E,s)=>{s.d(E,{Q:()=>L});var u=s(7582),O=s(1135),l=s(9646),w=s(9841),a=s(4004),d=s(262),v=s(3900),A=(s(6463),s(5525)),n=s(5e3),I=s(4206),G=s(3385),M=s(8996),C=s(5363),b=s(3151),R=s(5813),h=s(2011),P=s(440);s(127);const D=new n.OlP("angularfire2.functions.origin"),N=new n.OlP("angularfire2.functions.region"),j=new n.OlP("angularfire2.functions.use-emulator");let U=(()=>{class o{constructor(e,t,r,i,c,m,T,J){const y=T,S=(0,l.of)(void 0).pipe((0,C.Q)(i.outsideAngular),(0,v.w)(()=>s.e(7568).then(s.bind(s,7568))),(0,a.U)(()=>(0,h.on)(e,r,t)),(0,a.U)(f=>(0,h.cc)(`${f.name}.functions.${c||m}`,"AngularFireFunctions",f.name,()=>{let p;if(c&&m)throw new Error("REGION and ORIGIN can't be used at the same time.");return p=f.functions(c||m||void 0),y&&p.useEmulator(...y),p},[c,m,y])),(0,b.d)({bufferSize:1,refCount:!1}));return this.httpsCallable=(f,p)=>$=>(0,M.D)(S).pipe((0,C.Q)(i.insideAngular),(0,v.w)(F=>F.httpsCallable(f,p)($)),(0,a.U)(F=>F.data)),(0,h.pX)(this,S,r)}}return o.\u0275fac=function(e){return new(e||o)(n.LFG(h.Dh),n.LFG(h.xv,8),n.LFG(n.R0b),n.LFG(R.HU),n.LFG(N,8),n.LFG(D,8),n.LFG(j,8),n.LFG(P.nm,8))},o.\u0275prov=n.Yz7({token:o,factory:o.\u0275fac,providedIn:"any"}),o})(),L=(()=>{class o{constructor(e,t,r,i){this.firestore=e,this.auth=t,this.fns=r,this.afs=i,this.cart=[],this.cart$=new O.X([])}loginWithEmail(e){return this.auth.signInWithEmailAndPassword(e.email,e.password)}signup(e){return this.auth.createUserWithEmailAndPassword(e.email,e.password)}saveDetails(e){return this.firestore.collection("users").doc(e.uid).set(e)}getDetails(e){const t="string"==typeof e?e:e.uid;return this.firestore.collection("users").doc(t).valueChanges()}updateCart(e){const t=JSON.parse(localStorage.getItem("user"));return t&&t.uid?this.firestore.collection("users").doc(t.uid).update({cart:e}):Promise.reject("User not logged in")}get isLoggedIn(){const e=JSON.parse(localStorage.getItem("user"));return null!==e&&!1!==e.emailVerified}get isEmailVerified(){const e=JSON.parse(localStorage.getItem("user"));return!1!==(null==e?void 0:e.emailVerified)}authUser(e){return JSON.parse(localStorage.getItem("Users")||"[]").find(r=>r.user.userName===e.userName&&r.password===e.password)}addProductWithId(e,t){return this.firestore.collection("products").doc(e).set(t)}getProducts(){return this.firestore.collection("products").snapshotChanges().pipe((0,a.U)(e=>e.map(t=>{const r=t.payload.doc.data(),i=t.payload.doc.id;return r&&"object"==typeof r?Object.assign({id:i},r):(console.warn("Received non-object data:",r),{id:i})})))}getCartObservable(){return this.cart$.asObservable()}addToCart(e){const t=this.cart.find(r=>r.id===e.id);t?t.quantity+=e.quantity:this.cart.push(e),this.cart$.next(this.cart)}increaseCartItemQuantity(e){const t=this.cart.findIndex(r=>r.id===e.id);-1!==t&&this.cart[t].quantity++,this.cart$.next(this.cart)}decreaseCartItemQuantity(e){const t=this.cart.findIndex(r=>r.id===e.id);-1!==t&&(this.cart[t].quantity>1?this.cart[t].quantity--:this.cart.splice(t,1)),this.cart$.next(this.cart)}removeCartItem(e){this.cart=this.cart.filter(t=>t.id!==e.id),this.cart$.next(this.cart)}getCart(){return this.cart$.asObservable()}getRawCart(){return[...this.cart]}getTotalItems(){return this.cart.reduce((e,t)=>e+t.quantity,0)}getTotalPrice(){return this.cart.reduce((e,t)=>e+t.quantity*t.price,0)}clearCart(){this.cart=[],this.cart$.next([])}incCartItem(e){this.increaseCartItemQuantity(e)}decCartItem(e){this.decreaseCartItemQuantity(e)}getTotalAmount(){return this.cart$.pipe((0,a.U)(e=>e.reduce((t,r)=>t+r.price*r.quantity,0)))}updateProductQuantities(e){return(0,u.mG)(this,void 0,void 0,function*(){try{const t=this.firestore.firestore.batch();for(const r of e.items){if(!r.productId||"string"!=typeof r.productId){console.error("Invalid product ID:",r.productId);continue}const i=this.firestore.collection("products").doc(r.productId).ref;(yield i.get()).exists?t.update(i,{qty:(0,A.nP)(-r.quantity),lastUpdated:new Date}):console.warn(`Product does not exist: ${r.productId}`)}return yield t.commit(),!0}catch(t){return console.error("Error updating product quantities:",t),!1}})}getLowStockCount(e=10){return this.firestore.collection("products",t=>t.where("qty","<=",e)).valueChanges().pipe((0,a.U)(t=>t.length),(0,d.K)(()=>(0,l.of)(0)))}getOrderCount(){return this.firestore.collection("receipts").valueChanges().pipe((0,a.U)(e=>e.length),(0,d.K)(()=>(0,l.of)(0)))}getNewReviewsCount(){return this.firestore.collection("reviews",e=>e.where("status","==","pending")).valueChanges().pipe((0,a.U)(e=>e.length),(0,d.K)(()=>(0,l.of)(0)))}sendReceiptEmail(e,t){return fetch("https://us-central1-harware-8f5e9.cloudfunctions.net/sendReceiptEmail",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(Object.assign({email:e},t))})}saveReceipt(e){return this.afs.collection("receipts").doc(e.id).set(e)}getAllUsers(){return this.firestore.collection("users").snapshotChanges().pipe((0,a.U)(e=>e.map(t=>{const r=t.payload.doc.data();return Object.assign({},r)})))}getAllUsersSimple(){return this.firestore.collection("users").valueChanges({idField:"uid"})}updateUserData(e,t){return(0,u.mG)(this,void 0,void 0,function*(){try{return yield this.firestore.collection("users").doc(e).update(t),!0}catch(r){throw console.error("Error updating user:",r),r}})}deleteUser(e){return(0,u.mG)(this,void 0,void 0,function*(){try{yield this.firestore.collection("users").doc(e).delete();const t=yield this.auth.currentUser;if(!t||t.uid!==e)throw new Error("Admin must reauthenticate to delete other users");return yield t.delete(),!0}catch(t){throw console.error("Error deleting user:",t),t}})}updateUserEmail(e,t){return(0,u.mG)(this,void 0,void 0,function*(){try{const r=yield this.auth.currentUser;return r&&(yield r.updateEmail(t)),yield this.firestore.collection("users").doc(e).update({email:t,emailVerified:!1}),!0}catch(r){throw console.error("Error updating email:",r),r}})}updateUserPassword(e){return(0,u.mG)(this,void 0,void 0,function*(){try{const t=yield this.auth.currentUser;return!!t&&(yield t.updatePassword(e),!0)}catch(t){throw console.error("Error updating password:",t),t}})}getUser(e){return(0,u.mG)(this,void 0,void 0,function*(){try{const t=yield this.firestore.collection("users").doc(e).get().toPromise();return t.exists?t.data():null}catch(t){throw console.error("Error getting user:",t),t}})}submitReview(e){return(0,u.mG)(this,void 0,void 0,function*(){try{const t=yield this.getCurrentUser();if(!t)throw new Error("User not authenticated");const r=this.firestore.collection("reviews").doc().ref,i=r.id,c=Object.assign(Object.assign({},e),{reviewId:i,userId:t.uid,userEmail:t.email||"",userName:e.userName||t.displayName||(t.email?t.email.split("@")[0]:"User"),date:(new Date).toISOString(),status:"pending",lastUpdated:(new Date).toISOString()});return yield r.set(c),i}catch(t){throw console.error("Error submitting review:",t),t}})}getCurrentUserEmail(){return new Promise((e,t)=>{this.auth.onAuthStateChanged(r=>{console.log("Auth state changed. User:",r),e(r)},t)})}getUserData(e){return(0,u.mG)(this,void 0,void 0,function*(){try{const t=yield this.firestore.collection("users").doc(e).get().toPromise();return t.exists?t.data():null}catch(t){return console.error("Error getting user data:",t),null}})}getCurrentUser(){return new Promise((e,t)=>{this.auth.onAuthStateChanged(r=>{console.log("\u{1f525} Firebase Auth State Changed. User:",r),e(r)},r=>{console.error("Error in onAuthStateChanged:",r),t(r)})})}getCartOnce(){return new Promise(e=>{this.getCartObservable().subscribe(t=>{e(t)}).unsubscribe()})}getAllReviewsMessages(){return this.firestore.collection("reviews").valueChanges({idField:"id"}).pipe((0,v.w)(e=>e&&0!==e.length?(0,w.a)(e.map(t=>this.firestore.collection("messages",r=>r.where("reviewId","==",t.id).orderBy("date","asc")).valueChanges().pipe((0,a.U)(r=>Object.assign(Object.assign({},t),{messages:r||[],loadingMessages:!1})),(0,d.K)(r=>(console.error(`Error loading messages for review ${t.id}:`,r),(0,l.of)(Object.assign(Object.assign({},t),{messages:[],loadingMessages:!1}))))))):(0,l.of)([])),(0,d.K)(e=>(console.error("Error loading reviews:",e),(0,l.of)([]))))}sendMessageToUser(e,t,r){return(0,u.mG)(this,void 0,void 0,function*(){try{return yield this.firestore.collection("messages").add({reviewId:r,userId:e,text:t,fromAdmin:!0,date:(new Date).toISOString(),read:!1}),!0}catch(i){return console.error("Error sending message:",i),!1}})}getAllReviewsWithMessages(){return(0,w.a)([this.firestore.collection("reviews").valueChanges({idField:"reviewId"}),this.firestore.collection("messages").valueChanges({idField:"id"})]).pipe((0,a.U)(([e,t])=>e.map(r=>Object.assign(Object.assign({},r),{messages:t.filter(i=>i.reviewId===r.reviewId).sort((i,c)=>new Date(i.date).getTime()-new Date(c.date).getTime()),loadingMessages:!1}))),(0,d.K)(e=>(console.error("Error loading reviews with messages:",e),(0,l.of)([]))))}getMessagesFromReplyies(e){return this.firestore.collection("messages",t=>t.where("reviewId","==",e).orderBy("date","asc")).valueChanges({idField:"id"})}deleteReview(e){return this.firestore.collection("reviews").doc(e).delete()}updateReviewStatus(e,t){return this.firestore.collection("reviews").doc(e).update({status:t,lastUpdated:(new Date).toISOString()})}getUnreadMessageCount(e){return this.firestore.collection("messages",t=>t.where("userId","==",e).where("read","==",!1)).valueChanges().pipe((0,a.U)(t=>t.length))}}return o.\u0275fac=function(e){return new(e||o)(n.LFG(I.ST),n.LFG(G.zQ),n.LFG(U),n.LFG(I.ST))},o.\u0275prov=n.Yz7({token:o,factory:o.\u0275fac,providedIn:"root"}),o})()}}]);